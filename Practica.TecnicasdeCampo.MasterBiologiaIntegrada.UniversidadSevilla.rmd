---
title: "Practica.TecnicasdeCampo.MasterBiologiaIntegrada.UniversidadSevilla"
author: "Marcial"
date: "05/21/2018"
output: html_document
editor_options: 
  chunk_output_type: console
---
1. Install and load packages

```{r, echo = F}
#library("devtools")
#devtools::install_github("jinyizju/V.PhyloMaker2")
library(V.PhyloMaker2)

# github (requires `remotes` or `devtools`)
#devtools::install_github("ecoinfor/U.Taxonstand")
library(U.Taxonstand)

```


3. Frequency matrix.

```{r, echo = F}
mydata <- read.csv("./transectos.csv") 
dim(mydata)
mydata

```



3. Create your tree and plot

```{r, echo = F}

# load the database

library(openxlsx)
#dat1 <- read.xlsx("WFO_v2.1_20230304_part1.xlsx")
#dat2 <- read.xlsx("WFO_v2.1_20230304_part2.xlsx")
#dat3 <- read.xlsx("WFO_v2.1_20230304_part3.xlsx")
dat1 <- read.xlsx("Plants_WP_database_part1.xlsx")
dat2 <- read.xlsx("Plants_WP_database_part2.xlsx")
dat3 <- read.xlsx("Plants_WP_database_part3.xlsx")
database <- rbind(dat1, dat2, dat3)
#We are going to use the WP database but there are many differnt options
#Check here https://github.com/nameMatch/Database/tree/main

rm(dat1, dat2, dat3)

corrected.species <- nameMatch(mydata$ESPECIES,spSource=database, author = FALSE, max.distance= 1, matchFirst=TRUE)

corrected.species
#make corrections to your database if necessary
names(corrected.species)
write.csv(corrected.species, file = "corrected.species.csv")

c1<- corrected.species$Accepted_SPNAME
c2<- corrected.species$Genus_in_database
c3<- corrected.species$Family
mydata2 <- data.frame(species = c1, genus = c2, family = c3)

mytree <- phylo.maker(sp.list = mydata2, tree = GBOTB.extended.WP, nodes = nodes.info.1.WP, scenarios = "S2")
#There is available S1 and S3 and nodes.info.2.WP.csv

plot(mytree$scenario.2, cex = 0.5)





pdffn = paste0("myphylo", ".scenario2.pdf")
pdf(file=pdffn, width=6, height=60)
plot(mytree$scenario.2, cex = 0.5)
dev.off()
write.tree(mytree$scenario.2, file = "mytree2.tree")



```


4. Calculate phylogenetic diversity statistics.

```{r}
mydata$ESPECIES <- corrected.species$Accepted_SPNAME

mydata$ESPECIES<- gsub(" ", "_", mydata$ESPECIES)

library(picante)

setdiff(mytree$scenario.2$tip.label,mydata$ESPECIES)

pdffn = paste0("plotting", ".community1.pdf")
pdf(file=pdffn, width=6, height=6)
color.plot.phylo(mytree$scenario.2, mydata, names(mydata)[2], "ESPECIES", leg.cex = 0.6, main = paste0(names(mydata)[2]))
dev.off()

#ETC. ETC. ETC.
#Do this with all the plot

mytree <- mytree$scenario.2
?pd
#Explore the function and run the examples
dim(mydata)
names(mydata)
mydata <- mydata[1:41,2:25]
rownames(mydata) <- corrected.species$Accepted_SPNAME
rownames(mydata)<- gsub(" ", "_", rownames(mydata))
dim(mydata)

mytree$node.label <- NULL
mypd <- pd(t(mydata), mytree, include.root=TRUE)
mypd

?mpd
#Explore the function and run the examples

mympd <- mpd(t(mydata), cophenetic(mytree), abundance.weighted=T)
mympd
myresults1 <- cbind(mypd, mympd)

?mntd
#Explore the function and run the examples

mymntd <- mntd(t(mydata), cophenetic(mytree), abundance.weighted=T)
mymntd
myresults2 <- cbind(myresults1, mymntd)
colnames(myresults2) <- c("PD", "SR", "MPD", "MNTD")
myresults2
write.table(myresults2, file = "diversity_index_results.txt")

mycomdist <- comdist(t(mydata), cophenetic(mytree), abundance.weighted=T)
library(cluster)
mycomdist.clusters <- hclust(mycomdist)

pdffn = paste0("mpd", ".phylogeneticbetadiversity.pdf")
pdf(file=pdffn, width=6, height=6)
plot(mycomdist.clusters, main = "Dendrogram based on beta MPD")
dev.off()


mycomdistnt1 <- comdistnt(t(mydata), cophenetic(mytree), abundance.weighted=F, exclude.conspecifics = T)
mycomdistnt1.clusters <- hclust(mycomdistnt1)
pdffn = paste0("mntd_excluding", ".phylogeneticbetadiversity.pdf")
pdf(file=pdffn, width=6, height=6)
plot(mycomdistnt1.clusters, main = "Dendrogram based on beta MNTD excluding conspecifics")
dev.off()

mycomdistnt2 <- comdistnt(t(mydata), cophenetic(mytree), abundance.weighted=F, exclude.conspecifics = F)
mycomdistnt2.clusters <- hclust(mycomdistnt2)
pdffn = paste0("mntd_including", ".phylogeneticbetadiversity.pdf")
pdf(file=pdffn, width=6, height=6)
plot(mycomdistnt2.clusters, main = "Dendrogram based on beta MNTD including conspecifics")
dev.off()

```


5. We are going to check for phylogenetic clustering and overdispersion
```{r}
my.ses.pd <- ses.pd(t(mydata), mytree, null.model = "taxa.labels",
runs = 999)
my.ses.pd
write.table(my.ses.pd, file="ses.pd.result.txt")

my.ses.mpd <- ses.mpd(t(mydata), cophenetic(mytree), null.model = "taxa.labels",
abundance.weighted = T, runs = 999)
my.ses.mpd
write.table(my.ses.mpd, file="ses.mpd.result.txt")


my.ses.mntd <- ses.mntd(t(mydata), cophenetic(mytree), null.model = "taxa.labels",
abundance.weighted = T, runs = 999)
my.ses.mntd
write.table(my.ses.mntd, file="ses.mntd.result.txt")



?comm.phylo.cor

comm.phylo.cor.r <- comm.phylo.cor(t(mydata), mytree, metric="cij",null.model="sample.taxa.labels")
comm.phylo.cor.r
par(mai=c(1.02,0.82,0.82,0.42))
pdffn = paste0("comm.phylo.cor", ".phylogeneticbetadiversity.pdf")
pdf(file=pdffn, width=6, height=6)
hist(comm.phylo.cor.r$random.corrs)
abline(v=comm.phylo.cor.r$obs.corr)
dev.off()

```


6. We are going to calculate the phylogenetic signal
```{r}

mydata <- read.delim("Transectos.txt", header = T,  check.names = F)
mydata
mydata <- mydata[1:44,1:18]
mydata
mydata$Especie <- species 

#install.packages("caper")
library(caper)
?phylo.d

mytree$node.label <- NULL
mydata$Endemismo[mydata$Endemismo == "end\xe9mica"] <- 1
mydata$Endemismo[mydata$Endemismo == "end\xe9mica_restringida"] <- 1
mydata$Endemismo[mydata$Endemismo == "no_end\xe9mica"] <- 0

myphylo.d <- phylo.d(mydata, mytree, Especie, Endemismo, permut = 1000, rnd.bias=NULL)
myphylo.d

pdffn = paste0("phylogenetic_signal", ".endmicity.pdf")
pdf(file=pdffn, width=6, height=6)
plot(myphylo.d)
dev.off()

```


7. We are going to make some calculations of phylogenetic distinctivenes

```{r}

mydata <- read.delim("Transectos.txt", header = T,  check.names = F)
mydata
mydata <- mydata[1:44,1:18]
mydata
mydata$Especie <- species 

library(picante)

?evol.distinct
my.evol.distinct <- evol.distinct(mytree, type = "fair.proportion", scale = FALSE, use.branch.lengths = TRUE)

my.evol.distinct
mean(my.evol.distinct[,2])
#This is the total evolutionary distinctiveness

mydata[,3][mydata[,5] != 0]
speciestoprune <- setdiff(mytree$tip.label,mydata[,3][mydata[,5] != 0])
speciestoprune
mytree.Bosque1 <- drop.tip(mytree, speciestoprune)
Bosque1.evol.distinct <- evol.distinct(mytree.Bosque1, type = "fair.proportion", scale = FALSE, use.branch.lengths = TRUE)
mean(Bosque1.evol.distinct[,2])
#As example, this is the evolutionary distinctivenes of the community 1
#You can also calculate this for the rest of the communities

```

